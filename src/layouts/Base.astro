---
/**
 * 全てのページのベースになるレイアウト。
 * ヘッダーとフッターがある。
 */

import type { AstroImage } from "@types";

export interface Props {
  title: string;
  description: string;
  image?: string | ImageMetadata | Promise<AstroImage>;
  imageAlt?: string;
  noindex?: boolean;
  children: any;
}

import { getImage } from "astro:assets";
import { ViewTransitions } from "astro:transitions";

import { SEO } from "astro-seo";

import "@/styles/global.scss";
import "@/styles/bulma.scss";

import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";

const { title, description, image: _image, imageAlt, noindex } = Astro.props;

// imageとimageAltが片方だけ指定されている場合はエラーを出す
if ((_image == undefined) != (imageAlt == undefined)) {
  throw new Error("imageとimageAltが片方だけ指定されています");
}

const imageUrl = _image
  ? typeof _image === "string"
    ? String(new URL(_image, Astro.url))
    : (await getImage({ src: _image })).src // importされた画像を取得する
  : undefined;
const hasImage = imageUrl != undefined && imageAlt != undefined;
---

<html lang="ja" transition:animate="none">
  <head>
    <SEO
      title={title}
      charset="utf-8"
      description={description}
      canonical={String(new URL(Astro.url.pathname, Astro.site))}
      openGraph={hasImage
        ? {
            basic: {
              title,
              type: "website",
              image: imageUrl,
            },
            optional: {
              description,
            },
            image: {
              alt: imageAlt,
            },
          }
        : undefined}
      twitter={{
        card: hasImage ? "summary_large_image" : "summary",
        title,
        description,
        image: hasImage ? imageUrl : undefined,
        imageAlt: hasImage ? imageAlt : undefined,
      }}
      noindex={noindex}
      nofollow={noindex}
    />

    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />

    {
      // セキュリティ対策。というよりSEO対策。
      import.meta.env.PROD && (
        <>
          <meta
            http-equiv="Content-Security-Policy"
            content="default-src 'self'"
          />
          <meta
            http-equiv="Content-Security-Policy"
            content="upgrade-insecure-requests"
          />
          <meta http-equiv="Permissions-Policy" content="interest-cohort=()" />
          <meta http-equiv="X-FRAME-OPTIONS" content="DENY" />
        </>
      )
    }
  </head>
  <body>
    <Header />
    <slot />
    <Footer />
  </body>
</html>

<ViewTransitions />
